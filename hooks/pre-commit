#!/bin/zsh
# Safety pre-commit hook for dotfiles

echo "üîí Running safety checks..."

# Check for secrets in common files (exclude this hook file)
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -v "^hooks/"); do
    # Check for AWS keys
    if grep -iq "aws.*secret" "$file" 2>/dev/null; then
        echo "‚ùå ERROR: Possible AWS secret found in $file"
        exit 1
    fi
    
    # Check for private keys
    if grep -iq "PRIVATE KEY" "$file" 2>/dev/null; then
        echo "‚ùå ERROR: Private key found in $file"
        exit 1
    fi
    
    # Check for password patterns
    if grep -iq "password\s*=\s*['\"]" "$file" 2>/dev/null; then
        echo "‚ö†Ô∏è  WARNING: Possible password found in $file"
    fi
done

# Check for large files (>1MB)
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
    if [ "$size" -gt 1048576 ]; then
        echo "‚ùå ERROR: Large file detected: $file ($(($size/1024/1024))MB)"
        exit 1
    fi
done

# Check for merge conflicts
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if grep -iq "<<<<<<< HEAD" "$file" 2>/dev/null; then
        echo "‚ùå ERROR: Unresolved merge conflict in $file"
        exit 1
    fi
done

echo "‚úÖ Safety checks passed!"
exit 0
